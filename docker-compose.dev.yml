services:
  postgres:
    image: postgis/postgis:15-3.3
    container_name: postgres_db
    environment:
      POSTGRES_DB: locations_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      TZ: Europe/Moscow
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  app:
    container_name: nizhny_maps_dev
    build:
      context: .
      dockerfile: Dockerfile
    working_dir: /app
    volumes:
      - .:/app
      - uv_cache:/root/.cache/uv
    ports:
      - "8501:8501"
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=Europe/Moscow
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/locations_db
    depends_on:
      - postgres
    command: >
      bash -lc "
        uv pip install --index-url https://download.pytorch.org/whl/cpu torch==2.9.0 &&
        if [ -f requirements.txt ]; then uv pip install --no-cache-dir -r requirements.txt; fi &&
        echo '‚è≥ –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –ø–æ–∫–∞ PostgreSQL –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è...' &&
        sleep 10 &&
        echo 'üìä –ó–∞–ø—É—Å–∫ –≤—ã–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...' &&
        uv run python src/simple_importer.py data_/cultural_objects_mnn.xlsx &&
        uv run streamlit run main.py --server.port=8501 --server.address=0.0.0.0 --server.runOnSave true
      "

volumes:
  postgres_data:
  uv_cache:
